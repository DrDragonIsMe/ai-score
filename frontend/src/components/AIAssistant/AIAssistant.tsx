import React, { useState, useRef, useEffect } from 'react';
import {
  Modal,
  Input,
  Button,
  Avatar,
  List,
  Upload,
  message,
  Spin,
  Card,
  Tabs,
  Space,
  Typography,
  Divider,
  Tag,
  Tooltip,
  Row,
  Col,
  Statistic
} from 'antd';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import remarkMath from 'remark-math';
import rehypeKatex from 'rehype-katex';
import rehypeHighlight from 'rehype-highlight';
import rehypeRaw from 'rehype-raw';
import 'katex/dist/katex.min.css';
import {
  SendOutlined,
  CameraOutlined,
  RobotOutlined,
  UserOutlined,
  PictureOutlined,
  BulbOutlined,
  BookOutlined,
  HeartOutlined,
  CloseOutlined,
  SearchOutlined,
  FileTextOutlined,
  FilePdfOutlined,
  PaperClipOutlined,
  FileAddOutlined,
  PartitionOutlined
} from '@ant-design/icons';
import type { UploadFile } from 'antd/es/upload/interface';
import { useAIAssistantStore } from '../../stores/aiAssistantStore';
import type { Message } from '../../stores/aiAssistantStore';
import CameraCapture from './CameraCapture';
import PPTTemplateSelector from '../PPTTemplateSelector/PPTTemplateSelector';
import KnowledgeGraphEditor from '../KnowledgeGraphEditor/KnowledgeGraphEditor';
import './AIAssistant.css';

const { TextArea } = Input;
const { Text, Title } = Typography;

interface AIAssistantProps {
  visible: boolean;
  onClose: () => void;
}

const AIAssistant: React.FC<AIAssistantProps> = ({ visible, onClose }) => {
  const {
    messages,
    inputValue,
    loading,
    showPPTTemplateSelector,
    selectedTemplateId,
    selectedTemplateName,
    aiStats,
    addMessage,
    setInputValue,
    setLoading,
    setShowPPTTemplateSelector,
    setSelectedTemplate,
    incrementTodayInteractions,
    loadPptTemplates,
  } = useAIAssistantStore();
  
  const [activeTab, setActiveTab] = useState('chat');
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState<any[]>([]);
  const [searchLoading, setSearchLoading] = useState(false);
  const [showCamera, setShowCamera] = useState(false);
  const [showKnowledgeGraphEditor, setShowKnowledgeGraphEditor] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const pdfInputRef = useRef<HTMLInputElement>(null);

  // ÊªöÂä®Âà∞Â∫ïÈÉ®
  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  useEffect(() => {
    // ÁªÑ‰ª∂ÊåÇËΩΩÊó∂Âä†ËΩΩPPTÊ®°Êùø
    loadPptTemplates();
  }, [loadPptTemplates]);

  // ÂèëÈÄÅÊ∂àÊÅØ
  const handleSendMessage = async () => {
    if (!inputValue.trim()) return;

    const userMessage: Message = {
      id: Date.now().toString(),
      type: 'user',
      content: inputValue,
      timestamp: new Date()
    };

    addMessage(userMessage);
    setInputValue('');
    setLoading(true);

    try {
      const response = await fetch('http://localhost:5001/api/ai-assistant/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: inputValue,
          context: messages.slice(-5).map(msg => ({
            type: msg.type,
            content: msg.content,
            timestamp: msg.timestamp.toISOString()
          })),
          template_id: selectedTemplateId
        })
      });

      const result = await response.json();

      if (result.success) {
        const assistantMessage: Message = {
          id: (Date.now() + 1).toString(),
          type: 'assistant',
          content: result.data.response || result.response,
          timestamp: new Date(),
          referencedDocuments: result.data.referenced_documents || []
        };
        addMessage(assistantMessage);
        incrementTodayInteractions();
      } else {
        throw new Error(result.message || 'ÂèëÈÄÅÂ§±Ë¥•');
      }
    } catch (error) {
      console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error);
      message.error('ÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
      
      const errorMessage: Message = {
        id: (Date.now() + 1).toString(),
        type: 'assistant',
        content: 'Êä±Ê≠âÔºåÊàëÁé∞Âú®ÈÅáÂà∞‰∫Ü‰∏Ä‰∫õÈóÆÈ¢òÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇÂ¶ÇÊûúÈóÆÈ¢òÊåÅÁª≠Â≠òÂú®ÔºåËØ∑ËÅîÁ≥ªÊäÄÊúØÊîØÊåÅ„ÄÇ',
        timestamp: new Date()
      };
      addMessage(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  // Â§ÑÁêÜPPTÊ®°ÊùøÈÄâÊã©
  const handleTemplateSelect = (templateId: number, templateName: string) => {
    setSelectedTemplate(templateId, templateName);
    message.success(`Â∑≤ÈÄâÊã©Ê®°ÊùøÔºö${templateName}`);
  };

  // ÁîüÊàêPPT
  const handleGeneratePPT = async () => {
    if (!inputValue.trim()) {
      message.warning('ËØ∑ËæìÂÖ•PPTÂÜÖÂÆπÊèèËø∞');
      return;
    }

    const userMessage: Message = {
      id: Date.now().toString(),
      type: 'user',
      content: `ÁîüÊàêPPTÔºö${inputValue}${selectedTemplateName ? ` (‰ΩøÁî®Ê®°ÊùøÔºö${selectedTemplateName})` : ''}`,
      timestamp: new Date()
    };

    addMessage(userMessage);
    setInputValue('');
    setLoading(true);

    try {
      const response = await fetch('http://localhost:5001/api/ai-assistant/generate-ppt', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          content: inputValue,
          template_id: selectedTemplateId
        })
      });

      const result = await response.json();

      if (result.success) {
        const assistantMessage: Message = {
          id: (Date.now() + 1).toString(),
          type: 'assistant',
          content: result.data.message || 'PPTÁîüÊàêÊàêÂäüÔºÅ',
          timestamp: new Date()
        };
        addMessage(assistantMessage);
      } else {
        throw new Error(result.message || 'PPTÁîüÊàêÂ§±Ë¥•');
      }
    } catch (error) {
      console.error('PPTÁîüÊàêÂ§±Ë¥•:', error);
      message.error('PPTÁîüÊàêÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    } finally {
      setLoading(false);
    }
  };

  // Â§ÑÁêÜÈîÆÁõò‰∫ã‰ª∂
  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  // Ê∏≤ÊüìÊ∂àÊÅØ
  const renderMessage = (msg: Message) => {
    const isUser = msg.type === 'user';
    return (
      <div key={msg.id} className={`message ${isUser ? 'user-message' : 'assistant-message'}`}>
        <div className="message-avatar">
          <Avatar 
            icon={isUser ? <UserOutlined /> : <RobotOutlined />} 
            style={{ backgroundColor: isUser ? '#1890ff' : '#52c41a' }}
          />
        </div>
        <div className="message-content">
          <div className="message-body">
            {isUser ? (
              <Text>{msg.content}</Text>
            ) : (
              <ReactMarkdown
                remarkPlugins={[remarkGfm, remarkMath]}
                rehypePlugins={[rehypeKatex, rehypeHighlight, rehypeRaw]}
                components={{
                   // Ëá™ÂÆö‰πâ‰ª£Á†ÅÂùóÊ∏≤Êüì
                   code: ({ className, children, ...props }: any) => {
                     const match = /language-(\w+)/.exec(className || '');
                     const isInline = !match;
                     return isInline ? (
                       <code className={className} {...props}>
                         {children}
                       </code>
                     ) : (
                       <pre className={className}>
                         <code>{children}</code>
                       </pre>
                     );
                   },
                  // Ëá™ÂÆö‰πâË°®Ê†ºÊ∏≤Êüì
                  table: ({ children }) => (
                    <table style={{ 
                      border: '1px solid #d9d9d9', 
                      borderCollapse: 'collapse',
                      width: '100%',
                      marginBottom: '16px'
                    }}>
                      {children}
                    </table>
                  ),
                  th: ({ children }) => (
                    <th style={{ 
                      border: '1px solid #d9d9d9', 
                      padding: '8px 12px',
                      backgroundColor: '#fafafa',
                      fontWeight: 'bold'
                    }}>
                      {children}
                    </th>
                  ),
                  td: ({ children }) => (
                    <td style={{ 
                      border: '1px solid #d9d9d9', 
                      padding: '8px 12px'
                    }}>
                      {children}
                    </td>
                  ),
                }}
              >
                {msg.content}
              </ReactMarkdown>
            )}
          </div>
          
          {/* ÊòæÁ§∫ÂºïÁî®ÊñáÊ°£ */}
          {msg.referencedDocuments && msg.referencedDocuments.length > 0 && (
            <div className="referenced-documents">
              <Text type="secondary" style={{ fontSize: '12px' }}>ÂèÇËÄÉÊñáÊ°£Ôºö</Text>
              {msg.referencedDocuments.map((doc: any, index: number) => (
                <div key={index} className="referenced-doc">
                  <Text style={{ fontSize: '12px' }}>
                    üìÑ {doc.title} (Áõ∏ÂÖ≥Â∫¶: {(doc.relevance_score * 100).toFixed(1)}%)
                  </Text>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    );
  };

  // AIÁªüËÆ°Âç°Áâá
  const renderAIStatsCard = () => (
    <Card 
      title="AI‰∫íÂä®ÁªüËÆ°" 
      size="small" 
      style={{ marginBottom: 16 }}
      extra={<RobotOutlined style={{ color: '#1890ff' }} />}
    >
      <Row gutter={[16, 16]}>
        <Col span={12}>
          <Statistic 
            title="‰ªäÊó•‰∫íÂä®" 
            value={aiStats.todayInteractions} 
            suffix="Ê¨°"
            valueStyle={{ color: '#1890ff', fontSize: '16px' }}
          />
        </Col>
        <Col span={12}>
          <Statistic 
            title="ÊÄª‰∫íÂä®" 
            value={aiStats.totalInteractions} 
            suffix="Ê¨°"
            valueStyle={{ color: '#52c41a', fontSize: '16px' }}
          />
        </Col>
        <Col span={12}>
          <Statistic 
            title="ÈóÆÈ¢òËß£Á≠î" 
            value={aiStats.questionsAnswered} 
            suffix="‰∏™"
            valueStyle={{ color: '#722ed1', fontSize: '16px' }}
          />
        </Col>
        <Col span={12}>
          <Statistic 
            title="AIÂáÜÁ°ÆÁéá" 
            value={aiStats.aiAccuracy} 
            suffix="%"
            valueStyle={{ color: '#fa8c16', fontSize: '16px' }}
          />
        </Col>
      </Row>
    </Card>
  );

  const tabItems = [
    {
      key: 'chat',
      label: (
        <span>
          <RobotOutlined />
          AIÂØπËØù
        </span>
      ),
      children: (
        <div className="chat-container">
          {/* AIÁªüËÆ°Âç°Áâá */}
          {renderAIStatsCard()}
          
          {/* Ê∂àÊÅØÂàóË°® */}
          <div className="messages-container">
            {messages.map(renderMessage)}
            {loading && (
              <div className="message assistant-message">
                <div className="message-avatar">
                  <Avatar icon={<RobotOutlined />} style={{ backgroundColor: '#52c41a' }} />
                </div>
                <div className="message-content">
                  <div className="message-body loading">
                    <Spin size="small" />
                    <Text style={{ marginLeft: '8px', color: '#666' }}>È´òÂ∞èÂàÜÊ≠£Âú®ÊÄùËÄÉ...</Text>
                  </div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          {/* Âø´Êç∑Êìç‰Ωú */}
          <div className="quick-actions">
            <Space wrap>
              <Button 
                type="text" 
                icon={<PictureOutlined />} 
                size="small"
                onClick={() => fileInputRef.current?.click()}
              >
                ÂõæÁâá‰∏ä‰º†
              </Button>
              <Button 
                type="text" 
                icon={<FilePdfOutlined />} 
                size="small"
                onClick={() => pdfInputRef.current?.click()}
              >
                PDF‰∏ä‰º†
              </Button>
              <Button 
                type="text" 
                icon={<CameraOutlined />} 
                size="small"
                onClick={() => setShowCamera(true)}
              >
                ÊãçÁÖß
              </Button>
              <Button 
                type="text" 
                icon={<FileTextOutlined />} 
                size="small"
                onClick={() => setShowPPTTemplateSelector(true)}
              >
                PPTÊ®°Êùø
              </Button>
              <Button 
                type="text" 
                icon={<PartitionOutlined />} 
                size="small"
                onClick={() => setShowKnowledgeGraphEditor(true)}
              >
                Áü•ËØÜÂõæË∞±
              </Button>
              <Button 
                type="primary" 
                icon={<FileAddOutlined />} 
                size="small"
                onClick={handleGeneratePPT}
                disabled={!inputValue.trim()}
              >
                ÁîüÊàêPPT
              </Button>
            </Space>
          </div>

          {/* ËæìÂÖ•Âå∫Âüü */}
          <div className="input-container">
            <TextArea
              value={inputValue}
              onChange={(e) => setInputValue(e.target.value)}
              onKeyPress={handleKeyPress}
              placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò...ÔºàÊåâ Enter ÂèëÈÄÅÔºåShift+Enter Êç¢Ë°åÔºâ"
              autoSize={{ minRows: 2, maxRows: 6 }}
              disabled={loading}
            />
            <div className="send-button">
              <Button
                type="primary"
                icon={<SendOutlined />}
                onClick={handleSendMessage}
                disabled={loading || !inputValue.trim()}
                loading={loading}
              >
                ÂèëÈÄÅ
              </Button>
            </div>
          </div>
        </div>
      ),
    },
    {
      key: 'search',
      label: (
        <span>
          <SearchOutlined />
          ÊñáÊ°£ÊêúÁ¥¢
        </span>
      ),
      children: (
        <div className="search-container">
          <div className="search-input">
            <Input.Search
              placeholder="ÊêúÁ¥¢ÊñáÊ°£ÂÜÖÂÆπ..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              loading={searchLoading}
              enterButton="ÊêúÁ¥¢"
            />
          </div>
          <div className="search-results">
            {searchResults.length > 0 ? (
              <List
                dataSource={searchResults}
                renderItem={(item: any) => (
                  <List.Item>
                    <List.Item.Meta
                      title={item.title}
                      description={item.content}
                    />
                  </List.Item>
                )}
              />
            ) : (
              <div className="no-results">
                <Text type="secondary">ÊöÇÊó†ÊêúÁ¥¢ÁªìÊûú</Text>
              </div>
            )}
          </div>
        </div>
      ),
    },
  ];

  return (
    <>
      <Modal
        title={
          <div className="modal-header">
            <div className="header-left">
              <Avatar icon={<RobotOutlined />} style={{ backgroundColor: '#52c41a', marginRight: 8 }} />
              <div>
                <Title level={4} style={{ margin: 0 }}>È´òÂ∞èÂàÜAIÂä©Êâã</Title>
                {selectedTemplateName && (
                  <Text type="secondary" style={{ fontSize: '12px' }}>
                    Â∑≤ÈÄâÊã©Ê®°ÊùøÔºö{selectedTemplateName}
                  </Text>
                )}
              </div>
            </div>
            <Button 
              type="text" 
              icon={<CloseOutlined />} 
              onClick={onClose}
            />
          </div>
        }
        open={visible}
        onCancel={onClose}
        footer={null}
        width={800}
        height={600}
        className="ai-assistant-modal"
        destroyOnClose
      >
        <Tabs 
          activeKey={activeTab} 
          onChange={setActiveTab} 
          items={tabItems}
          className="ai-assistant-tabs"
        />
      </Modal>

      {/* ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• */}
      <input
        ref={fileInputRef}
        type="file"
        accept="image/*"
        style={{ display: 'none' }}
      />
      <input
        ref={pdfInputRef}
        type="file"
        accept=".pdf"
        style={{ display: 'none' }}
      />

      {/* Áõ∏Êú∫ÁªÑ‰ª∂ */}
      <CameraCapture
        visible={showCamera}
        onClose={() => setShowCamera(false)}
        onCapture={(imageData) => {
          console.log('Captured image:', imageData);
          setShowCamera(false);
        }}
      />

      {/* PPTÊ®°ÊùøÈÄâÊã©Âô® */}
      <PPTTemplateSelector
        visible={showPPTTemplateSelector}
        onClose={() => setShowPPTTemplateSelector(false)}
        onSelect={handleTemplateSelect}
        selectedTemplateId={selectedTemplateId}
      />

      {/* Áü•ËØÜÂõæË∞±ÁºñËæëÂô® */}
      <KnowledgeGraphEditor
        visible={showKnowledgeGraphEditor}
        onClose={() => setShowKnowledgeGraphEditor(false)}
        onSuccess={(knowledgeGraph) => {
          // ‰ªéËäÇÁÇπ‰∏≠ÊèêÂèñÊ†áÁ≠æ
          const nodeTags: string[] = [];
          if (knowledgeGraph.knowledge_graph?.nodes) {
            knowledgeGraph.knowledge_graph.nodes.forEach((node: any) => {
              if (node.tags && Array.isArray(node.tags)) {
                nodeTags.push(...node.tags);
              }
            });
          }
          // ÂéªÈáç
          const uniqueTags = [...new Set(nodeTags)];
          
          // Â∞ÜÁü•ËØÜÂõæË∞±ÁªìÊûúÊ∑ªÂä†Âà∞ËÅäÂ§©‰∏≠
          const assistantMessage: Message = {
            id: Date.now().toString(),
            type: 'assistant',
            content: `Â∑≤ÊàêÂäüÁîüÊàêÁü•ËØÜÂõæË∞±ÔºÅ\n\n**Â≠¶Áßë**: ${knowledgeGraph.subject_id}\n**ÂÜÖÂÆπ**: ${knowledgeGraph.content}\n**Ê†áÁ≠æ**: ${uniqueTags.join(', ') || 'Êó†'}\n\nÁü•ËØÜÂõæË∞±ÂåÖÂê´ ${knowledgeGraph.knowledge_graph?.nodes?.length || 0} ‰∏™ËäÇÁÇπÂíå ${knowledgeGraph.knowledge_graph?.edges?.length || 0} ‰∏™ËøûÊé•„ÄÇ`,
            timestamp: new Date()
          };
          addMessage(assistantMessage);
          setShowKnowledgeGraphEditor(false);
        }}
      />
    </>
  );
};

export default AIAssistant;