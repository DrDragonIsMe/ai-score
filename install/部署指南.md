# AI智能学习系统 - 部署指南

**版本**: v1.2.2  
**更新日期**: 2025-01-15  
**适用环境**: macOS, Linux, Windows

## 🆕 v1.2.2 更新内容

- **依赖更新**: 更新前端和后端依赖包到最新稳定版本
- **诊断工具**: 新增学习分析诊断脚本和数据修复工具
- **自动化脚本**: 添加系统健康检查和自动修复功能
- **性能优化**: 优化数据库查询和API响应速度
- **安全增强**: 增强前端认证系统的安全性和稳定性  

## 📋 目录

- [系统要求](#系统要求)
- [环境准备](#环境准备)
- [快速部署](#快速部署)
- [开发环境](#开发环境)
- [生产环境](#生产环境)
- [配置说明](#配置说明)
- [故障排除](#故障排除)
- [维护指南](#维护指南)

## 🔧 系统要求

### 最低配置

- **操作系统**: macOS 10.15+, Ubuntu 18.04+, Windows 10+
- **内存**: 4GB RAM
- **存储**: 2GB 可用空间
- **网络**: 稳定的互联网连接

### 推荐配置

- **操作系统**: macOS 12+, Ubuntu 20.04+, Windows 11+
- **内存**: 8GB+ RAM
- **存储**: 10GB+ 可用空间
- **处理器**: 多核处理器

### 软件依赖

- **Python**: 3.8+ (推荐 3.9+)
- **Node.js**: 16+ (推荐 18+)
- **数据库**: SQLite (开发) / PostgreSQL (生产)
- **Git**: 最新版本

## 🚀 环境准备

### 1. 安装 Python

```bash
# macOS (使用 Homebrew)
brew install python@3.9

# Ubuntu
sudo apt update
sudo apt install python3.9 python3.9-pip python3.9-venv

# Windows
# 从 https://python.org 下载并安装
```

### 2. 安装 Node.js

```bash
# macOS (使用 Homebrew)
brew install node@18

# Ubuntu
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# Windows
# 从 https://nodejs.org 下载并安装
```

### 3. 验证安装

```bash
python3 --version  # 应显示 3.8+
node --version     # 应显示 16+
npm --version      # 应显示 8+
git --version      # 应显示 2.0+
```

## ⚡ 快速部署

### 1. 克隆项目

```bash
git clone <repository-url>
cd ai-score
```

### 2. 自动安装脚本 (推荐)

```bash
# macOS 用户
./install/install_macos.sh

# 手动安装
./install/manual_install.sh
```

### 3. 启动服务

```bash
# 启动后端服务
cd backend
source venv/bin/activate  # Windows: venv\Scripts\activate
FLASK_APP=app.py FLASK_ENV=development FLASK_DEBUG=1 flask run --host=0.0.0.0 --port=5001

# 启动前端服务 (新终端)
cd frontend
npm run dev
```

### 4. 访问系统

- **前端界面**: http://localhost:5173
- **后端API**: http://localhost:5001
- **API文档**: http://localhost:5001/api/docs

## 🛠️ 开发环境

### 后端开发环境

```bash
cd backend

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt

# 初始化数据库
flask db init
flask db migrate -m "Initial migration"
flask db upgrade

# 启动开发服务器
FLASK_APP=app.py FLASK_ENV=development FLASK_DEBUG=1 flask run --host=0.0.0.0 --port=5001
```

### 前端开发环境

```bash
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build

# 预览生产版本
npm run preview
```

### 开发工具配置

#### VS Code 推荐插件

```json
{
  "recommendations": [
    "ms-python.python",
    "ms-python.flake8",
    "ms-python.black-formatter",
    "bradlc.vscode-tailwindcss",
    "esbenp.prettier-vscode",
    "ms-vscode.vscode-typescript-next"
  ]
}
```

#### 代码格式化

```bash
# Python 代码格式化
black backend/
flake8 backend/

# JavaScript 代码格式化
npx prettier --write frontend/src/
npx eslint frontend/src/ --fix
```

## 🏭 生产环境

### 1. 环境变量配置

创建 `.env` 文件：

```bash
# 数据库配置
DATABASE_URL=postgresql://user:password@localhost:5432/ai_score

# 安全配置
SECRET_KEY=your-secret-key-here
JWT_SECRET_KEY=your-jwt-secret-key

# API 配置
OPENAI_API_KEY=your-openai-api-key
OPENAI_BASE_URL=https://api.openai.com/v1

# 应用配置
FLASK_ENV=production
FLASK_DEBUG=0
PORT=5001
```

### 2. 数据库配置

#### PostgreSQL 安装

```bash
# macOS
brew install postgresql
brew services start postgresql

# Ubuntu
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 创建数据库
sudo -u postgres createdb ai_score
sudo -u postgres createuser --interactive
```

### 3. 使用 Docker 部署

#### Dockerfile (后端)

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 5001

CMD ["gunicorn", "--bind", "0.0.0.0:5001", "app:app"]
```

#### docker-compose.yml

```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "5001:5001"
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/ai_score
    depends_on:
      - db

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend

  db:
    image: postgres:13
    environment:
      - POSTGRES_DB=ai_score
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

### 4. 使用 Nginx 反向代理

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:5173;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api {
        proxy_pass http://localhost:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## ⚙️ 配置说明

### 后端配置文件

#### `backend/config/config.py`

```python
import os
from datetime import timedelta

class Config:
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'dev-secret-key'
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or 'sqlite:///app.db'
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    JWT_SECRET_KEY = os.environ.get('JWT_SECRET_KEY') or 'jwt-secret-key'
    JWT_ACCESS_TOKEN_EXPIRES = timedelta(hours=1)
    
class DevelopmentConfig(Config):
    DEBUG = True
    
class ProductionConfig(Config):
    DEBUG = False
```

### 前端配置文件

#### `frontend/vite.config.js`

```javascript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:5001',
        changeOrigin: true
      }
    }
  },
  build: {
    outDir: 'dist',
    sourcemap: true
  }
})
```

## 🔍 故障排除

### 依赖更新问题

#### 1. Python 依赖更新

```bash
# 检查过时的包
pip list --outdated

# 更新所有包到最新版本
pip install --upgrade -r requirements.txt

# 如果遇到冲突，使用pip-tools
pip install pip-tools
pip-compile --upgrade requirements.in
pip-sync requirements.txt

# 检查安全漏洞
pip install pip-audit
pip-audit
```

#### 2. Node.js 依赖更新

```bash
# 检查过时的包
npm outdated

# 更新所有依赖
npm update

# 更新到最新主版本（谨慎使用）
npx npm-check-updates -u
npm install

# 检查安全漏洞
npm audit
npm audit fix
```

#### 3. 学习分析诊断工具

```bash
# 运行学习分析诊断脚本
cd backend
python diagnostic_scripts/learning_analytics_check.py

# 数据修复工具
python repair_scripts/fix_learning_data.py

# 系统健康检查
python health_check.py --full
```

### 常见问题

#### 1. 端口占用

```bash
# 查看端口占用
lsof -i :5001
lsof -i :5173

# 杀死进程
kill -9 <PID>
```

#### 2. 数据库连接失败

```bash
# 检查数据库状态
psql -h localhost -U postgres -d ai_score

# 重置数据库
flask db downgrade
flask db upgrade
```

#### 3. 依赖安装失败

```bash
# 清理缓存
pip cache purge
npm cache clean --force

# 重新安装
pip install -r requirements.txt --force-reinstall
npm install --force
```

#### 4. 权限问题

```bash
# macOS/Linux
sudo chown -R $USER:$USER .
chmod +x install/*.sh

# Windows (以管理员身份运行)
```

#### 5. 学习分析功能异常

```bash
# 检查学习分析API状态
curl -X GET "http://localhost:5001/api/learning-analytics/dashboard" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 修复学习分析数据
cd backend
python repair_scripts/fix_analytics_data.py

# 重建学习分析索引
python manage.py rebuild_analytics_index
```

#### 6. 认证系统问题

```bash
# 检查JWT配置
echo $JWT_SECRET_KEY

# 清除认证缓存
redis-cli FLUSHDB

# 重新生成JWT密钥
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

### 日志查看

```bash
# 后端日志
tail -f backend/logs/app.log

# 前端开发服务器日志
# 直接在终端查看

# 系统日志
# macOS
log show --predicate 'process == "python"' --last 1h

# Linux
journalctl -u your-service-name -f
```

## 🔧 维护指南

### 定期维护任务

#### 每日检查（自动化脚本）

```bash
#!/bin/bash
# daily_check.sh - 每日自动检查脚本

# 检查服务状态
curl -f http://localhost:5001/api/health || echo "Backend down"
curl -f http://localhost:5173 || echo "Frontend down"

# 检查学习分析功能
curl -f http://localhost:5001/api/learning-analytics/health || echo "Analytics down"

# 检查日志错误
grep -i error backend/logs/*.log | tail -10

# 检查数据库连接
psql -h localhost -U postgres -d ai_score -c "SELECT 1;" || echo "Database connection failed"

# 检查磁盘空间
df -h | grep -E '(8[0-9]|9[0-9])%' && echo "Disk space warning"

# 性能监控
python backend/performance_monitor.py --daily
```

#### 每周维护（增强版）

```bash
#!/bin/bash
# weekly_maintenance.sh

# 依赖更新检查
echo "=== 检查Python依赖更新 ==="
pip list --outdated

echo "=== 检查Node.js依赖更新 ==="
npm outdated

# 数据库优化
echo "=== 数据库维护 ==="
psql -h localhost -U postgres -d ai_score -c "VACUUM ANALYZE;"
psql -h localhost -U postgres -d ai_score -c "REINDEX DATABASE ai_score;"

# 数据库备份
echo "=== 数据库备份 ==="
pg_dump ai_score > backup_$(date +%Y%m%d).sql
gzip backup_$(date +%Y%m%d).sql

# 清理日志和临时文件
echo "=== 清理系统 ==="
find backend/logs -name "*.log" -mtime +7 -delete
find backend/temp -name "*" -mtime +3 -delete

# 学习分析数据清理
python backend/cleanup_analytics.py --older-than 30
```

#### 每月维护（全面优化）

```bash
#!/bin/bash
# monthly_maintenance.sh

# 系统更新
echo "=== 系统更新 ==="
brew update && brew upgrade  # macOS
# sudo apt update && sudo apt upgrade  # Ubuntu

# 安全扫描
echo "=== 安全扫描 ==="
pip-audit --format=json --output=security_report.json
npm audit --json > npm_security_report.json

# 性能分析
echo "=== 性能分析 ==="
python backend/performance_analyzer.py --full-report

# 数据库性能优化
echo "=== 数据库性能优化 ==="
psql -h localhost -U postgres -d ai_score -f backend/sql/optimize_queries.sql

# 学习分析数据统计
echo "=== 学习分析统计 ==="
python backend/analytics_stats.py --monthly-report
```

### 备份策略

#### 数据库备份

```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/path/to/backups"

# 创建备份
pg_dump ai_score > "$BACKUP_DIR/ai_score_$DATE.sql"

# 压缩备份
gzip "$BACKUP_DIR/ai_score_$DATE.sql"

# 删除7天前的备份
find "$BACKUP_DIR" -name "*.sql.gz" -mtime +7 -delete

echo "Backup completed: ai_score_$DATE.sql.gz"
```

#### 代码备份

```bash
# 自动推送到远程仓库
git add .
git commit -m "Auto backup $(date)"
git push origin main

# 创建标签
git tag -a "backup-$(date +%Y%m%d)" -m "Daily backup"
git push origin --tags
```

### 监控和告警

#### 健康检查端点

```python
# backend/api/health.py
from flask import Blueprint, jsonify
from datetime import datetime

health_bp = Blueprint('health', __name__)

@health_bp.route('/health')
def health_check():
    return jsonify({
        'status': 'healthy',
        'timestamp': datetime.utcnow().isoformat(),
        'version': '1.1.0'
    })
```

#### 简单监控脚本

```bash
#!/bin/bash
# monitor.sh

check_service() {
    local url=$1
    local name=$2
    
    if curl -f -s "$url" > /dev/null; then
        echo "✅ $name is healthy"
    else
        echo "❌ $name is down"
        # 发送告警邮件或通知
    fi
}

check_service "http://localhost:5001/api/health" "Backend"
check_service "http://localhost:5173" "Frontend"
```

## 📞 技术支持

### 获取帮助

1. **文档**: 查看项目 `install/` 目录下的相关文档
2. **日志**: 检查 `backend/logs/` 目录下的日志文件
3. **GitHub Issues**: 在项目仓库提交问题
4. **技术社区**: 相关技术栈的官方社区

### 报告问题

提交问题时请包含：

- 操作系统和版本
- Python 和 Node.js 版本
- 错误信息和日志
- 复现步骤
- 系统配置信息

---

**文档版本**: 1.0  
**最后更新**: 2025-08-30  
**维护者**: 开发团队